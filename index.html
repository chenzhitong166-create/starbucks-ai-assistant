<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ˜Ÿå·´å…‹é—¨åº—æ™ºèƒ½åŠ©æ‰‹ (Barista Copilot)</title>
<style>
    :root {
        --sb-green: #00704A; /* æ˜Ÿå·´å…‹å®˜æ–¹ç»¿ */
        --sb-dark: #1e3932;
        --sb-accent: #d4e9e2;
        --bg-color: #f1f8f6;
        --chat-bg: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    
    body {
        background-color: var(--bg-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .main-container {
        width: 100%;
        max-width: 900px;
        height: 90vh; /* å æ®å±å¹•é«˜åº¦çš„90% */
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 112, 74, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid rgba(0, 112, 74, 0.1);
    }

    /* === å¤´éƒ¨åŒºåŸŸ === */
    .header {
        background-color: var(--sb-green);
        color: white;
        padding: 20px 30px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-shrink: 0;
    }

    .logo-circle {
        width: 45px;
        height: 45px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .header-info h1 {
        font-size: 20px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .header-info p {
        font-size: 12px;
        opacity: 0.8;
        margin-top: 4px;
    }

    /* === èŠå¤©åŒºåŸŸ === */
    .chat-box {
        flex-grow: 1;
        padding: 30px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: #fdfdfd;
        scroll-behavior: smooth;
    }

    .message {
        max-width: 80%;
        padding: 15px 20px;
        border-radius: 16px;
        font-size: 15px;
        line-height: 1.6;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .message.user {
        align-self: flex-end;
        background-color: var(--sb-green);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.bot {
        align-self: flex-start;
        background-color: white;
        color: #333;
        border: 1px solid #eee;
        border-bottom-left-radius: 4px;
    }

    /* æ€è€ƒä¸­åŠ¨ç”» */
    .thinking-bubble {
        align-self: flex-start;
        background: white;
        padding: 10px 20px;
        border-radius: 20px;
        border: 1px solid #eee;
        color: #888;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .dots span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: #bbb;
        border-radius: 50%;
        animation: wave 1.3s linear infinite;
    }
    .dots span:nth-child(2) { animation-delay: -1.1s; }
    .dots span:nth-child(3) { animation-delay: -0.9s; }
    @keyframes wave {
        0%, 60%, 100% { transform: initial; }
        30% { transform: translateY(-5px); }
    }

    /* è€—æ—¶ç»Ÿè®¡ */
    .meta-info {
        display: block;
        margin-top: 8px;
        font-size: 11px;
        color: #aaa;
        text-align: right;
        font-style: italic;
    }

    /* === åº•éƒ¨è¾“å…¥åŒº === */
    .input-area {
        padding: 20px 30px;
        background: white;
        border-top: 1px solid #f0f0f0;
        display: flex;
        gap: 15px;
        flex-shrink: 0;
    }

    input {
        flex-grow: 1;
        padding: 12px 20px;
        border: 2px solid #eee;
        border-radius: 50px;
        font-size: 15px;
        outline: none;
        transition: border-color 0.3s;
    }

    input:focus {
        border-color: var(--sb-green);
    }

    button {
        background-color: var(--sb-green);
        color: white;
        border: none;
        padding: 0 25px;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        flex-shrink: 0;
    }

    button:hover {
        background-color: #005c3d;
    }
    
    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    /* === åº•éƒ¨æŠ€æœ¯æ ˆ (ç»™é¢è¯•å®˜çœ‹) === */
    .footer {
        text-align: center;
        padding: 15px;
        background: #fafafa;
        border-top: 1px solid #eee;
    }

    .tech-badges {
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .badge {
        font-size: 11px;
        color: #666;
        background: #e9ecef;
        padding: 4px 10px;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
        font-weight: 500;
    }
    
    /* é‡ç‚¹é«˜äº®æ ¸å¿ƒæŠ€æœ¯ */
    .badge.highlight {
        color: var(--sb-green);
        background: var(--sb-accent);
        border-color: var(--sb-accent);
    }

    /* Markdown ç®€å•æ ·å¼ */
    .message.bot strong { color: var(--sb-green); font-weight: 700; }
    .message.bot ul { padding-left: 20px; margin: 8px 0; }
    .message.bot li { margin-bottom: 4px; }
</style>
</head>
<body>

<div class="main-container">
    <!-- 1. å¤´éƒ¨ -->
    <div class="header">
        <div class="logo-circle">â˜•</div>
        <div class="header-info">
            <h1>æ˜Ÿå·´å…‹é—¨åº—æ™ºèƒ½åŠ©æ‰‹</h1>
            <p>SOP çŸ¥è¯†åº“ V2025.03 Â· å®æ—¶æ£€ç´¢</p>
        </div>
    </div>

    <!-- 2. èŠå¤©å†…å®¹åŒº -->
    <div class="chat-box" id="chatBox">
        <!-- æ¬¢è¿è¯­ -->
        <div class="message bot">
            <div>
                å—¨ï¼ä¼™ä¼´ ğŸ‘‹ï¼Œæˆ‘æ˜¯ä½ çš„å€¼ç­ AIã€‚<br>
                <strong>é…æ–¹æŸ¥è¯¢</strong>ã€<strong>æ•ˆæœŸç¡®è®¤</strong>ã€<strong>æ¸…æ´è§„èŒƒ</strong>ï¼Œè¯·ç›´æ¥é—®æˆ‘ï¼
            </div>
        </div>
    </div>

    <!-- 3. åº•éƒ¨è¾“å…¥åŒº -->
    <div class="input-area">
        <input type="text" id="chatInput" placeholder="è¾“å…¥é—®é¢˜ï¼Œä¾‹å¦‚ï¼šä¸‹ç­å‰è¦åšä»€ä¹ˆï¼Ÿ" onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()" id="sendBtn">å‘é€</button>
    </div>

    <!-- 4. æŠ€æœ¯é€‰å‹å±•ç¤º (é¢è¯•äº®ç‚¹) -->
    <div class="footer">
        <div class="tech-badges">
            <span class="badge highlight">n8n Workflow</span>
            <span class="badge highlight">DeepSeek V3</span>
            <span class="badge highlight">Pinecone Vector</span>
            <span class="badge">Gemini Embedding</span>
            <span class="badge">RAG Architecture</span>
            <span class="badge">Read/Write Split</span>
        </div>
    </div>
</div>

<script>
    // ğŸ”¥ã€è¯·ä¿®æ”¹è¿™é‡Œã€‘æ›¿æ¢ä¸ºä½ çš„ n8n Webhook URL
    const WEBHOOK_URL = "https://chenzhitong.app.n8n.cloud/webhook/starbucks-ai-assistant";

    const chatBox = document.getElementById('chatBox');
    const inputEl = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    let isProcessing = false;

    function handleKeyPress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        if (isProcessing) return;
        const text = inputEl.value.trim();
        if (!text) return;

        isProcessing = true;
        
        // 1. ä¸Šå±ç”¨æˆ·æ¶ˆæ¯
        addMessage(text, 'user');
        inputEl.value = '';
        inputEl.disabled = true;
        sendBtn.disabled = true;

        // 2. æ˜¾ç¤ºæ€è€ƒä¸­çŠ¶æ€
        const thinkingId = 'thinking-' + Date.now();
        const thinkingHTML = `
            <div class="thinking-bubble" id="${thinkingId}">
                <span>DeepSeek æ€è€ƒä¸­</span>
                <div class="dots"><span></span><span></span><span></span></div>
            </div>
        `;
        chatBox.insertAdjacentHTML('beforeend', thinkingHTML);
        scrollToBottom();

        const startTime = Date.now();

        try {
            // 3. å‘èµ·è¯·æ±‚
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input: text }) // n8n æ¥æ”¶çš„å­—æ®µå
            });

            if (!response.ok) throw new Error('Network error');
            
            // è§£æè¿”å› (å…¼å®¹å¤šç§æ ¼å¼)
            const responseText = await response.text();
            let aiResponseText = "";
            try {
                const data = JSON.parse(responseText);
                aiResponseText = data.output || data.text || data.answer || JSON.stringify(data);
            } catch {
                aiResponseText = responseText;
            }

            // 4. ç§»é™¤æ€è€ƒåŠ¨ç”»
            document.getElementById(thinkingId).remove();

            // 5. è®¡ç®—è€—æ—¶
            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);

            // 6. åˆ›å»ºæœºå™¨äººæ¶ˆæ¯å®¹å™¨
            const botMsgDiv = document.createElement('div');
            botMsgDiv.className = 'message bot';
            chatBox.appendChild(botMsgDiv);

            // 7. æ‰§è¡Œæ‰“å­—æœºæµå¼è¾“å‡º
            await typeWriter(botMsgDiv, aiResponseText);

            // 8. è¿½åŠ è€—æ—¶ç»Ÿè®¡
            const metaInfo = document.createElement('span');
            metaInfo.className = 'meta-info';
            metaInfo.innerText = `âš¡ æ€è€ƒè€—æ—¶: ${duration}s`;
            botMsgDiv.appendChild(metaInfo);

            scrollToBottom();

        } catch (error) {
            document.getElementById(thinkingId).remove();
            addMessage(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'bot');
        } finally {
            isProcessing = false;
            inputEl.disabled = false;
            sendBtn.disabled = false;
            inputEl.focus();
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ æ™®é€šæ¶ˆæ¯
    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerText = text;
        chatBox.appendChild(div);
        scrollToBottom();
    }

    // è¾…åŠ©å‡½æ•°ï¼šè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // æ ¸å¿ƒå‡½æ•°ï¼šæ‰“å­—æœºæ•ˆæœ (æ¨¡æ‹Ÿæµå¼)
    function typeWriter(element, text) {
        return new Promise(resolve => {
            // ç®€å•å¤„ç† Markdown æ¢è¡Œå’ŒåŠ ç²—
            // æ³¨æ„ï¼šæ­£å¼ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ marked.js åº“ï¼Œè¿™é‡Œä¸ºäº†å•æ–‡ä»¶æ¼”ç¤ºæ‰‹å†™ç®€å•æ›¿æ¢
            let formattedText = text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // å¤„ç†åŠ ç²—

            const contentSpan = document.createElement('div');
            element.appendChild(contentSpan);

            let i = 0;
            // æ—¢ç„¶å·²ç»æ ¼å¼åŒ–äº†HTMLï¼Œæˆ‘ä»¬å°±ä¸èƒ½é€å­—æ‰“å°HTMLæ ‡ç­¾äº†
            // è¿™é‡Œä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬ç›´æ¥æ‰“å°ï¼Œä½†æ¨¡æ‹Ÿå»¶è¿Ÿ
            // å¦‚æœè¿½æ±‚å®Œç¾é€å­—ï¼Œéœ€è¦è§£æHTMLèŠ‚ç‚¹ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼š
            // ç›´æ¥æ”¾å…¥HTMLï¼Œä½†ç”¨ CSS åŠ¨ç”»æ·¡å…¥ï¼Œæˆ–è€…åˆ†æ®µæ˜¾ç¤º
            
            // ç®€æ˜“ç‰ˆæ‰“å­—æœºï¼šæ¯15æ¯«ç§’æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦ï¼ˆçº¯æ–‡æœ¬æ¨¡å¼ï¼‰
            // ä¸ºäº†æ”¯æŒ HTML æ ¼å¼ï¼Œè¿™é‡Œæ”¹ä¸ºï¼šç›´æ¥æ˜¾ç¤ºï¼Œä½†ä¸ºäº†æ¨¡æ‹Ÿæµå¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æ®µ
            
            // ã€ä¿®æ­£ç­–ç•¥ã€‘ä¸ºäº†ä¿ç•™æ ¼å¼ï¼Œæˆ‘ä»¬ä¸æ‹†åˆ†æ ‡ç­¾ï¼Œè€Œæ˜¯ç›´æ¥æ˜¾ç¤º
            // å¦‚æœä½ æƒ³çœ‹é€å­—è·³åŠ¨çš„æ•ˆæœï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹é€»è¾‘ï¼š
            
            contentSpan.innerHTML = formattedText; 
            // å¦‚æœéœ€è¦è§†è§‰ä¸Šçš„â€œæµå¼â€ï¼Œé€šå¸¸é…åˆåç«¯ SSEã€‚
            // è¿™é‡Œå‰ç«¯æ¨¡æ‹Ÿï¼Œç›´æ¥æ˜¾ç¤ºå…¶å®ä½“éªŒæœ€å¥½ï¼Œä¸ä¼šç ´å HTML ç»“æ„ã€‚
            
            resolve();
        });
    }
</script>

</body>
</html>
