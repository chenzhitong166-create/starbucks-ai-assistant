<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ˜Ÿå·´å…‹é—¨åº—æ™ºèƒ½åŠ©æ‰‹ (Barista Copilot)</title>
<style>
    :root {
        /* æ˜Ÿå·´å…‹å“ç‰Œè‰²ç³» */
        --sb-green: #00704A;       /* æ ¸å¿ƒç»¿ */
        --sb-dark: #1e3932;        /* æ·±ç»¿èƒŒæ™¯ */
        --sb-gold: #CBA258;        /* æ˜Ÿå·´å…‹é‡‘ (ç²¾è‡´æ„Ÿæ¥æº) */
        --sb-light: #f1f8f6;       /* æµ…ç»¿èƒŒæ™¯ */
        --bg-color: #f7f7f7;       /* ç½‘é¡µèƒŒæ™¯ */
        --chat-bg: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    
    body {
        background-color: var(--bg-color);
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        /* å¢åŠ ä¸€ç‚¹çº¹ç†æ„Ÿ */
        background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
        background-size: 20px 20px;
    }

    .main-container {
        /* ä¿®æ”¹ç‚¹1ï¼šæ‰©å¤§å±å¹•å ç”¨ï¼Œæ›´åƒä¸€ä¸ªå®Œæ•´APP */
        width: 95%;
        max-width: 1200px;
        height: 95vh; 
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 50, 30, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid rgba(0, 112, 74, 0.1);
        position: relative;
    }

    /* é¡¶éƒ¨è£…é¥°æ¡ (é‡‘è‰²) */
    .top-bar {
        height: 6px;
        background: linear-gradient(90deg, var(--sb-green) 0%, var(--sb-gold) 100%);
        width: 100%;
    }

    /* === å¤´éƒ¨åŒºåŸŸ === */
    .header {
        background-color: white;
        padding: 20px 40px;
        display: flex;
        align-items: center;
        gap: 15px;
        border-bottom: 1px solid #f0f0f0;
        flex-shrink: 0;
    }

    .logo-container {
        position: relative;
    }

    .logo-circle {
        width: 50px;
        height: 50px;
        background: var(--sb-green);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        box-shadow: 0 4px 10px rgba(0, 112, 74, 0.2);
        border: 2px solid var(--sb-gold); /* é‡‘è‰²è¾¹æ¡† */
    }

    .header-info h1 {
        font-size: 22px;
        font-weight: 700;
        color: var(--sb-dark);
        letter-spacing: 0.5px;
    }

    .header-info p {
        font-size: 13px;
        color: #888;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        background-color: #4CAF50;
        border-radius: 50%;
        display: inline-block;
    }

    /* === èŠå¤©åŒºåŸŸ === */
    .chat-box {
        flex-grow: 1;
        padding: 40px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
        background: var(--chat-bg);
        scroll-behavior: smooth;
    }

    .message {
        max-width: 80%;
        padding: 18px 24px;
        border-radius: 18px;
        font-size: 16px;
        line-height: 1.6;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 2px 12px rgba(0,0,0,0.03);
    }

    .message.user {
        align-self: flex-end;
        background-color: var(--sb-green);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.bot {
        align-self: flex-start;
        background-color: #fcfcfc;
        color: #333;
        border: 1px solid #eee;
        border-bottom-left-radius: 4px;
    }
    
    /* æœºå™¨äººå¤´åƒè£…é¥° */
    .message.bot::before {
        content: 'ğŸ¤–'; /* è¿™é‡Œä¹Ÿå¯ä»¥æ¢æˆå›¾ç‰‡URL */
        position: absolute;
        left: -35px;
        top: 0;
        width: 28px;
        height: 28px;
        background: var(--sb-light);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    /* æ€è€ƒä¸­åŠ¨ç”» - ä¿çš®ç‰ˆ */
    .thinking-bubble {
        align-self: flex-start;
        margin-left: 35px; /* å¯¹é½å¤´åƒ */
        background: white;
        padding: 12px 24px;
        border-radius: 25px;
        border: 1px solid var(--sb-gold); /* é‡‘è‰²è¾¹æ¡†ä½“ç°æ€è€ƒ */
        color: var(--sb-green);
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(203, 162, 88, 0.1);
    }
    
    .coffee-spin {
        animation: spin 2s linear infinite;
        display: inline-block;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* è€—æ—¶ç»Ÿè®¡ */
    .meta-info {
        display: block;
        margin-top: 10px;
        font-size: 11px;
        color: #aaa;
        text-align: right;
        font-family: monospace;
    }

    /* === åº•éƒ¨åŒºåŸŸ === */
    .footer-wrapper {
        border-top: 1px solid #f0f0f0;
        background: #fafafa;
    }

    /* è¾“å…¥åŒº */
    .input-area {
        padding: 20px 40px;
        display: flex;
        gap: 15px;
    }

    input {
        flex-grow: 1;
        padding: 15px 25px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        outline: none;
        transition: all 0.3s;
        background: white;
    }

    input:focus {
        border-color: var(--sb-green);
        box-shadow: 0 0 0 3px rgba(0, 112, 74, 0.1);
    }

    button {
        background-color: var(--sb-green);
        color: white;
        border: none;
        padding: 0 35px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
    }

    button:hover { background-color: #005c3d; }
    button:active { transform: scale(0.98); }
    button:disabled { background-color: #ccc; cursor: not-allowed; }

    /* æŠ€æœ¯æ ˆå±•ç¤ºåŒº */
    .tech-footer {
        padding: 10px 40px 20px 40px;
        text-align: center;
    }
    
    .tech-desc {
        font-size: 12px;
        color: #888;
        margin-bottom: 10px;
    }

    .tech-badges {
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    /* ä¿®æ”¹ç‚¹3ï¼šå…¨ç»¿è‰²ç³»å¾½ç«  */
    .badge {
        font-size: 11px;
        color: var(--sb-green);
        background: rgba(0, 112, 74, 0.08);
        padding: 4px 12px;
        border-radius: 6px;
        border: 1px solid rgba(0, 112, 74, 0.15);
        font-weight: 600;
    }
    
    /* Markdown æ ·å¼ */
    .message.bot strong { color: var(--sb-green); font-weight: 700; background: rgba(0, 112, 74, 0.05); padding: 0 4px; border-radius: 4px;}
    .message.bot ul { padding-left: 20px; margin: 10px 0; }
    .message.bot li { margin-bottom: 6px; }

</style>
</head>
<body>

<div class="main-container">
    <div class="top-bar"></div> <!-- é‡‘è‰²é¡¶éƒ¨æ¡ -->

    <!-- 1. å¤´éƒ¨ -->
    <div class="header">
        <div class="logo-container">
            <div class="logo-circle">â˜•</div>
        </div>
        <div class="header-info">
            <h1>æ˜Ÿå·´å…‹é—¨åº—æ™ºèƒ½åŠ©æ‰‹</h1>
            <p><span class="status-dot"></span> åœ¨çº¿ | AI Operation Copilot</p>
        </div>
    </div>

    <!-- 2. èŠå¤©å†…å®¹åŒº -->
    <div class="chat-box" id="chatBox">
        <!-- ä¿®æ”¹ç‚¹5ï¼šæ¬¢è¿è¯­æ›´æ–° -->
        <div class="message bot">
            <div>
                å—¨ï¼ä¼™ä¼´ ğŸ‘‹ï¼Œæˆ‘æ˜¯ä½ çš„å€¼ç­ AIã€‚<br>
                <strong>é…æ–¹æŸ¥è¯¢</strong>ã€<strong>æ¸…æ´è§„èŒƒ</strong>ã€<strong>æœåŠ¡æŒ‡å—</strong>ï¼Œéšæ—¶é—®æˆ‘ï¼
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨åŒ…è£¹å±‚ -->
    <div class="footer-wrapper">
        <!-- 3. è¾“å…¥åŒº -->
        <div class="input-area">
            <input type="text" id="chatInput" placeholder="è¾“å…¥é—®é¢˜ï¼Œä¾‹å¦‚ï¼šå¤§æ¯å†°ç„¦ç³–ç›å¥‡æœµå‡ æ³µç³–ï¼Ÿ" onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" id="sendBtn">å‘é€</button>
        </div>

        <!-- 4. æŠ€æœ¯é€‰å‹ (ä¿®æ”¹ç‚¹3) -->
        <div class="tech-footer">
            <div class="tech-desc">æœ¬ç³»ç»Ÿä¸ºæŠ€æœ¯æ¼”ç¤º Demoï¼ŒåŸºäºä»¥ä¸‹æ¶æ„æ„å»ºï¼š</div>
            <div class="tech-badges">
                <span class="badge">n8n Workflow</span>
                <span class="badge">DeepSeek V3</span>
                <span class="badge">Pinecone Vector</span>
                <span class="badge">Gemini Embedding</span>
                <span class="badge">RAG Architecture</span>
                <span class="badge">Read/Write Split</span>
            </div>
        </div>
    </div>
</div>

<script>
    // ğŸ”¥ã€è¯·åœ¨æ­¤å¤„å¡«å…¥ä½ çš„ URLã€‘
    const WEBHOOK_URL = "https://chenzhitong.app.n8n.cloud/webhook/starbucks-ai-assistant";

    const chatBox = document.getElementById('chatBox');
    const inputEl = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    let isProcessing = false;

    // ä¿®æ”¹ç‚¹4ï¼šä¿çš®çš„æ€è€ƒæ–‡æ¡ˆ
    const thinkingSteps = [
        "â˜•ï¸ å°åŠ©æ‰‹æ­£åœ¨ç¿»é˜… SOP æ‰‹å†Œ...",
        "ğŸ” æ­£åœ¨æ£€ç´¢ Pinecone çŸ¥è¯†åº“...",
        "âœ¨ æ­£åœ¨åˆ†æé¥®å“é…æ–¹...",
        "ğŸ“ æ­£åœ¨æ•´ç†å›ç­”..."
    ];

    function handleKeyPress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        if (isProcessing) return;
        const text = inputEl.value.trim();
        if (!text) return;

        isProcessing = true;
        
        // 1. ä¸Šå±ç”¨æˆ·æ¶ˆæ¯
        addMessage(text, 'user');
        inputEl.value = '';
        inputEl.disabled = true;
        sendBtn.disabled = true;

        // 2. æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
        const thinkingId = 'thinking-' + Date.now();
        const thinkingHTML = `
            <div class="thinking-bubble" id="${thinkingId}">
                <span class="coffee-spin">â˜•ï¸</span>
                <span id="thinking-text">${thinkingSteps[0]}</span>
            </div>
        `;
        chatBox.insertAdjacentHTML('beforeend', thinkingHTML);
        scrollToBottom();

        // å¯åŠ¨æ–‡æ¡ˆè½®æ’­
        let stepIndex = 1;
        const intervalId = setInterval(() => {
            const textEl = document.querySelector(`#${thinkingId} #thinking-text`);
            if (textEl) {
                textEl.innerText = thinkingSteps[stepIndex % thinkingSteps.length];
                stepIndex++;
            }
        }, 1200);

        const startTime = Date.now();

        try {
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input: text }) 
            });

            if (!response.ok) throw new Error('Network error');
            
            const responseText = await response.text();
            let aiResponseText = "";
            try {
                const data = JSON.parse(responseText);
                aiResponseText = data.output || data.text || data.answer || data.content || JSON.stringify(data);
            } catch {
                aiResponseText = responseText;
            }

            // æ¸…ç†æ€è€ƒçŠ¶æ€
            clearInterval(intervalId);
            const thinkingEl = document.getElementById(thinkingId);
            if(thinkingEl) thinkingEl.remove();

            // 3. è®¡ç®—è€—æ—¶
            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);

            // 4. æœºå™¨äººå›å¤å®¹å™¨
            const botMsgDiv = document.createElement('div');
            botMsgDiv.className = 'message bot';
            chatBox.appendChild(botMsgDiv);

            // 5. æµå¼è¾“å‡º
            await typeWriter(botMsgDiv, aiResponseText);

            // 6. è€—æ—¶ç»Ÿè®¡
            const metaInfo = document.createElement('span');
            metaInfo.className = 'meta-info';
            metaInfo.innerText = `âš¡ æ€è€ƒè€—æ—¶: ${duration}s`;
            botMsgDiv.appendChild(metaInfo);

            scrollToBottom();

        } catch (error) {
            clearInterval(intervalId);
            const thinkingEl = document.getElementById(thinkingId);
            if(thinkingEl) thinkingEl.remove();
            addMessage(`âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ n8n: ${error.message}`, 'bot');
        } finally {
            isProcessing = false;
            inputEl.disabled = false;
            sendBtn.disabled = false;
            inputEl.focus();
        }
    }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerText = text;
        chatBox.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function typeWriter(element, text) {
        return new Promise(resolve => {
            let formattedText = text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/- /g, 'â€¢ ');

            // åˆ›å»ºå†…å®¹å®¹å™¨
            const contentSpan = document.createElement('div');
            contentSpan.innerHTML = formattedText; // ç®€å•èµ·è§ç›´æ¥æ¸²æŸ“ï¼Œè‹¥è¦è¿½æ±‚æè‡´é€å­—æ•ˆæœéœ€å¤æ‚é€»è¾‘
            
            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            contentSpan.style.opacity = 0;
            contentSpan.style.transition = 'opacity 0.5s';
            element.appendChild(contentSpan);
            
            // è§¦å‘åŠ¨ç”»
            requestAnimationFrame(() => {
                contentSpan.style.opacity = 1;
            });

            setTimeout(resolve, 500); 
        });
    }
</script>

</body>
</html>
