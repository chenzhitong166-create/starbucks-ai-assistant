<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ˜Ÿå·´å…‹é—¨åº—æ™ºèƒ½åŠ©æ‰‹ (Barista Copilot)</title>
<!-- âœ… å¼•å…¥ marked.js åº“ï¼šè®©åˆ—è¡¨å’ŒåŠ ç²—æ˜¾ç¤ºå¾—åƒæ–‡æ¡£ä¸€æ ·æ¼‚äº® -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    :root {
        --sb-green: #00704A;
        --sb-dark: #1e3932;
        --sb-gold: #CBA258;
        --sb-light: #f1f8f6;
        --bg-color: #f7f7f7;
        --chat-bg: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
    
    body {
        background-color: var(--bg-color);
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
        background-size: 20px 20px;
        overflow: hidden; 
    }

    .main-container {
        width: 95%;
        max-width: 1200px;
        height: 95vh; 
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 50, 30, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid rgba(0, 112, 74, 0.1);
        position: relative;
    }

    .top-bar {
        height: 6px;
        background: linear-gradient(90deg, var(--sb-green) 0%, var(--sb-gold) 100%);
        width: 100%;
        flex-shrink: 0;
    }

    /* === å¤´éƒ¨ === */
    .header {
        background-color: white;
        padding: 15px 30px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #f0f0f0;
        flex-shrink: 0;
    }

    .logo-circle {
        width: 44px;
        height: 44px;
        background: var(--sb-green);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        box-shadow: 0 4px 10px rgba(0, 112, 74, 0.2);
        border: 2px solid var(--sb-gold);
    }

    .header-info h1 {
        font-size: 18px;
        font-weight: 700;
        color: var(--sb-dark);
    }

    .header-info p {
        font-size: 12px;
        color: #888;
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .status-dot {
        width: 6px;
        height: 6px;
        background-color: #4CAF50;
        border-radius: 50%;
        display: inline-block;
    }

    /* === èŠå¤©åŒº === */
    .chat-box {
        flex-grow: 1;
        padding: 30px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: var(--chat-bg);
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch; 
    }

    .message {
        max-width: 85%;
        padding: 12px 20px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.6;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }

    .message.user {
        align-self: flex-end;
        background-color: var(--sb-green);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.bot {
        align-self: flex-start;
        background-color: #fcfcfc;
        color: #333;
        border: 1px solid #eee;
        border-bottom-left-radius: 4px;
        margin-left: 15px; 
    }
    
    .message.bot::before {
        content: 'â˜•'; 
        position: absolute;
        left: -42px; 
        top: 0;
        width: 32px;
        height: 32px;
        background: white;
        border: 1px solid #eee;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    /* === Markdown æ ·å¼ä¼˜åŒ– (è®©åˆ—è¡¨ä¸ä¹±) === */
    .message.bot p { margin: 0 0 10px 0; }
    .message.bot p:last-child { margin-bottom: 0; }
    
    .message.bot strong {
        color: var(--sb-green);
        font-weight: 700;
        background: rgba(0, 112, 74, 0.05);
        padding: 0 4px;
        border-radius: 4px;
    }

    .message.bot ul, .message.bot ol {
        margin: 8px 0;
        padding-left: 24px; /* å…³é”®ï¼šç»™åˆ—è¡¨ç•™å‡ºå·¦è¾¹è· */
    }

    .message.bot li {
        margin-bottom: 6px;
    }

    /* æ€è€ƒä¸­åŠ¨ç”» */
    .thinking-bubble {
        align-self: flex-start;
        margin-left: 55px;
        background: white;
        padding: 10px 20px;
        border-radius: 25px;
        border: 1px solid var(--sb-gold);
        color: var(--sb-green);
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(203, 162, 88, 0.1);
        opacity: 0; /* åˆå§‹éšè—ï¼Œé…åˆåŠ¨ç”» */
        animation: popIn 0.3s forwards;
    }
    
    @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .coffee-spin { animation: spin 2s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .meta-info {
        display: block;
        margin-top: 8px;
        font-size: 10px;
        color: #aaa;
        text-align: right;
        font-family: monospace;
    }

    /* === åº•éƒ¨åŒºåŸŸ === */
    .footer-wrapper {
        border-top: 1px solid #f0f0f0;
        background: #fafafa;
        flex-shrink: 0;
        padding-bottom: env(safe-area-inset-bottom);
    }

    .input-area {
        padding: 15px 30px;
        display: flex;
        gap: 10px;
    }

    input {
        flex-grow: 1;
        padding: 12px 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 15px;
        outline: none;
        transition: all 0.3s;
        background: white;
    }

    input:focus {
        border-color: var(--sb-green);
        box-shadow: 0 0 0 3px rgba(0, 112, 74, 0.1);
    }

    button {
        background-color: var(--sb-green);
        color: white;
        border: none;
        padding: 0 25px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
    }
    
    button:hover { background-color: #005c3d; }
    button:disabled { background-color: #ccc; }

    /* æŠ€æœ¯æ ˆåŒºåŸŸ */
    .tech-footer {
        padding: 5px 20px 15px 20px;
        text-align: center;
        background: #fcfcfc;
    }
    
    .tech-desc {
        font-size: 11px;
        color: #999;
        margin-bottom: 8px;
    }

    .tech-badges {
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .badge {
        font-size: 10px;
        color: var(--sb-green);
        background: rgba(0, 112, 74, 0.06);
        padding: 4px 10px;
        border-radius: 6px;
        border: 1px solid rgba(0, 112, 74, 0.1);
        font-weight: 500;
    }

    /* === ç§»åŠ¨ç«¯é€‚é… === */
    @media (max-width: 600px) {
        body {
            background-image: none;
            background-color: white;
        }

        .main-container {
            width: 100%;
            height: 100%;
            max-width: none;
            border-radius: 0;
            border: none;
            box-shadow: none;
        }

        .header { padding: 12px 15px; }
        .chat-box { padding: 20px; gap: 15px; }

        .message.bot { margin-left: 35px; }
        .message.bot::before { left: -40px; }

        .tech-desc { display: none; }
        .tech-badges { gap: 6px; padding-bottom: 5px; }
        .badge { font-size: 9px; padding: 3px 8px; }
        .input-area { padding: 10px 15px; }
    }

</style>
</head>
<body>

<div class="main-container">
    <div class="top-bar"></div>

    <!-- 1. å¤´éƒ¨ -->
    <div class="header">
        <div class="logo-container">
            <div class="logo-circle">â˜•</div>
        </div>
        <div class="header-info">
            <h1>æ˜Ÿå·´å…‹é—¨åº—æ™ºèƒ½åŠ©æ‰‹</h1>
            <p><span class="status-dot"></span> åœ¨çº¿ | AI Copilot</p>
        </div>
    </div>

    <!-- 2. èŠå¤©åŒº -->
    <div class="chat-box" id="chatBox">
        <div class="message bot">
            <div>
                å—¨ï¼ä¼™ä¼´ ğŸ‘‹ï¼Œæˆ‘æ˜¯ä½ çš„å°åŠ©æ‰‹ã€‚<br>
                <strong>é…æ–¹æŸ¥è¯¢</strong>ã€<strong>æ¸…æ´è§„èŒƒ</strong>ã€<strong>æœåŠ¡æŒ‡å—</strong>ï¼Œéšæ—¶é—®æˆ‘ï¼
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨åŒ…è£¹å±‚ -->
    <div class="footer-wrapper">
        <!-- 3. è¾“å…¥åŒº -->
        <div class="input-area">
            <input type="text" id="chatInput" placeholder="æ‹¿é“æ€ä¹ˆåšï¼Ÿ">
            <button onclick="sendMessage()" id="sendBtn">å‘é€</button>
        </div>

        <!-- 4. æŠ€æœ¯é€‰å‹ -->
        <div class="tech-footer">
            <div class="tech-desc">æœ¬ç³»ç»Ÿä¸ºæŠ€æœ¯æ¼”ç¤º Demoï¼ŒåŸºäºä»¥ä¸‹æ¶æ„æ„å»ºï¼š</div>
            <div class="tech-badges">
                <span class="badge">n8n Workflow</span>
                <span class="badge">DeepSeek V3</span>
                <span class="badge">Pinecone Vector</span>
                <span class="badge">Gemini Embedding</span>
            </div>
        </div>
    </div>
</div>

<script>
    // ğŸ”¥ã€é‡è¦ã€‘è¯·åœ¨æ­¤å¤„å¡«å…¥ä½ çš„ n8n Webhook URL
    const WEBHOOK_URL = "https://chenzhitong.app.n8n.cloud/webhook/starbucks-ai-assistant";

    const chatBox = document.getElementById('chatBox');
    const inputEl = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    let isProcessing = false;

    // âœ… æ ¸å¿ƒå‡çº§ï¼šä¼šè¯IDç®¡ç† (Session ID)
    // é€»è¾‘ï¼šå¦‚æœæœ¬åœ°æœ‰IDå°±ç”¨ï¼Œæ²¡æœ‰å°±ç”Ÿæˆæ–°çš„ã€‚è¿™æ ·åˆ·æ–°é¡µé¢IDä¸å˜ï¼Œä½†æ¸…ç©ºç¼“å­˜å˜ã€‚
    let sessionId = localStorage.getItem('sb_session_id');
    if (!sessionId) {
        sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('sb_session_id', sessionId);
    }
    console.log("Current Session ID:", sessionId);

    // ç›‘å¬å›è½¦é”® (ä¿®å¤ Mac å…¼å®¹æ€§)
    inputEl.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            sendMessage();
        }
    });

    // æ€è€ƒæ–‡æ¡ˆ
    const thinkingSteps = [
        "â˜•ï¸ å°åŠ©æ‰‹æ­£åœ¨ç¿»é˜…æ‰‹å†Œ...",
        "ğŸ” æ­£åœ¨æ£€ç´¢ Pinecone...",
        "ğŸ“ æ­£åœ¨æ•´ç†å›ç­”..."
    ];

    async function sendMessage() {
        if (isProcessing) return;
        const text = inputEl.value.trim();
        if (!text) return;

        isProcessing = true;
        
        // ä¸Šå±
        addMessage(text, 'user');
        inputEl.value = '';
        inputEl.disabled = true;
        sendBtn.disabled = true;

        // æ€è€ƒçŠ¶æ€
        const thinkingId = 'thinking-' + Date.now();
        const thinkingHTML = `
            <div class="thinking-bubble" id="${thinkingId}">
                <span class="coffee-spin">â˜•ï¸</span>
                <span id="thinking-text">${thinkingSteps[0]}</span>
            </div>
        `;
        chatBox.insertAdjacentHTML('beforeend', thinkingHTML);
        scrollToBottom();

        // è½®æ’­
        let stepIndex = 1;
        const intervalId = setInterval(() => {
            const textEl = document.querySelector(`#${thinkingId} #thinking-text`);
            if (textEl) {
                textEl.innerText = thinkingSteps[stepIndex % thinkingSteps.length];
                stepIndex++;
            }
        }, 1200);

        const startTime = Date.now();

        try {
            // âœ… å‘é€è¯·æ±‚ï¼šå¸¦ä¸Š input å’Œ sessionId
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    input: text,
                    sessionId: sessionId 
                }) 
            });

            if (!response.ok) throw new Error('Network error');
            
            const responseText = await response.text();
            let aiResponseText = "";
            try {
                const data = JSON.parse(responseText);
                aiResponseText = data.output || data.text || data.answer || data.content || JSON.stringify(data);
            } catch {
                aiResponseText = responseText;
            }

            // åœæ­¢æ€è€ƒ
            clearInterval(intervalId);
            const thinkingEl = document.getElementById(thinkingId);
            if(thinkingEl) thinkingEl.remove();

            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);

            // æœºå™¨äººå›å¤å®¹å™¨
            const botMsgDiv = document.createElement('div');
            botMsgDiv.className = 'message bot';
            chatBox.appendChild(botMsgDiv);

            // âœ… ä½¿ç”¨ marked.js æ¸²æŸ“ Markdown (è§£å†³åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜)
            const htmlContent = marked.parse(aiResponseText);
            
            // æµå¼/æ·¡å…¥æ˜¾ç¤º
            await typeWriter(botMsgDiv, htmlContent);

            // è€—æ—¶ç»Ÿè®¡
            const metaInfo = document.createElement('span');
            metaInfo.className = 'meta-info';
            metaInfo.innerText = `âš¡ æ€è€ƒè€—æ—¶: ${duration}s`;
            botMsgDiv.appendChild(metaInfo);

            scrollToBottom();

        } catch (error) {
            clearInterval(intervalId);
            const thinkingEl = document.getElementById(thinkingId);
            if(thinkingEl) thinkingEl.remove();
            addMessage(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'bot');
        } finally {
            isProcessing = false;
            inputEl.disabled = false;
            sendBtn.disabled = false;
            inputEl.focus();
        }
    }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerText = text;
        chatBox.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function typeWriter(element, htmlContent) {
        return new Promise(resolve => {
            // åˆ›å»ºå†…å®¹å®¹å™¨
            const contentSpan = document.createElement('div');
            // âœ… ç›´æ¥æ’å…¥è§£æå¥½çš„ HTMLï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
            contentSpan.innerHTML = htmlContent;
            
            // åˆå§‹éšè—
            contentSpan.style.opacity = 0;
            contentSpan.style.transition = 'opacity 0.5s ease-in-out';
            element.appendChild(contentSpan);
            
            // è§¦å‘æ·¡å…¥åŠ¨ç”»
            requestAnimationFrame(() => {
                contentSpan.style.opacity = 1;
            });

            // ç®€å•å»¶è¿Ÿ resolveï¼Œæ¨¡æ‹Ÿæ‰“å­—å®Œæˆ
            setTimeout(resolve, 600); 
        });
    }
</script>

</body>
</html>
